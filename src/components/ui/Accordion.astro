---
interface AccordionItem {
  question: string;
  answer: string;
}

interface Props {
  items: AccordionItem[];
  class?: string;
}

const { items, class: className = '' } = Astro.props;

// Function to convert URLs in text to clickable links
function linkify(text: string): string {
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  return text.replace(urlRegex, (url) => {
    return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-accent hover:underline break-all">${url}</a>`;
  });
}
---

<div class={`accordion space-y-2 md:space-y-3 ${className}`} role="region">
  {items.map((item, index) => (
    <div class="accordion-item bg-white rounded-xl md:rounded-2xl overflow-hidden shadow-sm relative z-10">
      <button
        class="accordion-trigger w-full flex items-center justify-between p-3 md:p-4 text-left text-sm md:text-base font-medium text-primary hover:bg-gray-50 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-inset"
        aria-expanded="false"
        aria-controls={`accordion-content-${index}`}
        id={`accordion-trigger-${index}`}
      >
        <span class="pr-3">{item.question}</span>
        <svg
          class="accordion-icon w-4 h-4 md:w-5 md:h-5 text-muted transition-transform duration-300 flex-shrink-0"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <div
        class="accordion-content hidden bg-white"
        id={`accordion-content-${index}`}
        aria-labelledby={`accordion-trigger-${index}`}
        role="region"
      >
        <div class="px-3 md:px-4 pb-3 md:pb-4 text-sm text-muted leading-relaxed" set:html={linkify(item.answer)}>
        </div>
      </div>
    </div>
  ))}
</div>

<script>
  function initAccordion() {
    const accordions = document.querySelectorAll('.accordion');
    
    accordions.forEach((accordion) => {
      const triggers = accordion.querySelectorAll('.accordion-trigger');
      
      triggers.forEach((trigger) => {
        trigger.addEventListener('click', () => {
          const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
          const content = accordion.querySelector(`#${trigger.getAttribute('aria-controls')}`);
          const icon = trigger.querySelector('.accordion-icon');
          
          // Toggle current item
          trigger.setAttribute('aria-expanded', (!isExpanded).toString());
          content?.classList.toggle('hidden');
          icon?.classList.toggle('rotate-180');
        });
        
        // Keyboard navigation
        trigger.addEventListener('keydown', (e) => {
          const event = e as KeyboardEvent;
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            (trigger as HTMLElement).click();
          }
        });
      });
    });
  }
  
  // Initialize on page load
  initAccordion();
  
  // Reinitialize on Astro page transitions
  document.addEventListener('astro:page-load', initAccordion);
</script>

<style>
  .accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
  }
  
  .accordion-content:not(.hidden) {
    max-height: 500px;
  }
</style>

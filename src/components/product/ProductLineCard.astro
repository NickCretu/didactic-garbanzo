---
import { useTranslations, getLocalizedPath, getTelegramOrderLink, type Language } from '@i18n/index';

interface FlavorVariant {
  slug: string;
  flavorCategory: string;
  flavorName: string;
  price: number;
}

interface ProductLine {
  id: string;
  brand: string;
  strength: number;
  strengthCategory: string;
  pouchesPerCan: number;
  currency: string;
  image: string;
  flavors: FlavorVariant[];
  minPrice: number;
  maxPrice: number;
}

interface Props {
  lang: Language;
  productLine: ProductLine;
}

const { lang, productLine } = Astro.props;
const t = useTranslations(lang);

const base = import.meta.env.BASE_URL || '/';
const baseClean = base.endsWith('/') ? base.slice(0, -1) : base;

// Use first product's image as representative
const imageSrc = productLine.image.startsWith('/') 
  ? `${baseClean}${productLine.image}` 
  : productLine.image;
const placeholderSrc = `${baseClean}/images/products/placeholder.svg`;

const strengthLabels: Record<string, string> = {
  low: t.strengths.low,
  medium: t.strengths.medium,
  strong: t.strengths.strong,
  extra: t.strengths.extra,
};

const flavorLabels: Record<string, string> = {
  mint: t.flavors.mint,
  citrus: t.flavors.citrus,
  berry: t.flavors.berry,
  coffee: t.flavors.coffee,
  tropical: t.flavors.tropical,
};

// Product line title without flavor
const title = `${productLine.brand} ${strengthLabels[productLine.strengthCategory]}`;

// Fixed Telegram order link (per PRD)
const telegramOrderLink = 'https://t.me/m/8ebhN3f-MDMy';
---

<article
  class="product-line-card group flex flex-col bg-surface rounded-xl p-3 md:p-4 hover:shadow-product transition-shadow overflow-hidden"
  data-strength={productLine.strengthCategory}
  data-flavors={productLine.flavors.map(f => f.flavorCategory).join(',')}
  data-line-id={productLine.id}
>
  <!-- Product Image -->
  <div class="relative aspect-square mb-3 overflow-hidden rounded-lg md:rounded-xl bg-white">
    <img
      src={imageSrc}
      alt={title}
      class="w-full h-full object-contain p-3 md:p-4 transition-transform duration-300 group-hover:scale-105"
      loading="lazy"
      onerror={`this.src='${placeholderSrc}'`}
    />
    <!-- Strength Badge -->
    <span class="absolute top-2 right-2 px-2 py-0.5 md:px-2.5 md:py-1 bg-white text-[10px] md:text-xs font-semibold text-primary rounded-full shadow-md border border-gray-100">
      {productLine.strength}{t.strengths.mg}
    </span>
  </div>
  
  <!-- Product Info -->
  <div class="flex-1 flex flex-col min-w-0">
    <span class="text-[10px] md:text-xs text-muted mb-0.5">{productLine.brand}</span>
    <h3 class="text-xs md:text-sm font-semibold text-primary mb-2">{title}</h3>
    
    <!-- Flavor Selection (optional) -->
    <div class="mb-3">
      <p class="text-[10px] md:text-xs text-muted mb-1.5">
        {lang === 'ru' ? 'Вкус (опц.):' : lang === 'ro' ? 'Aromă (opț.):' : 'Flavor (opt.):'}
      </p>
      <div class="flavor-chips flex flex-wrap gap-1">
        {productLine.flavors.map((flavor) => (
          <button
            type="button"
            class="flavor-chip px-2 py-0.5 md:px-2.5 md:py-1 text-[10px] md:text-xs rounded-full bg-white border border-gray-200 text-muted hover:border-accent hover:text-accent transition-all"
            data-flavor={flavor.flavorCategory}
            data-slug={flavor.slug}
            data-flavor-name={flavor.flavorName}
          >
            {flavorLabels[flavor.flavorCategory]}
          </button>
        ))}
      </div>
    </div>
    
    <!-- Actions -->
    <div class="mt-auto flex flex-col gap-1.5">
      <a
        href={telegramOrderLink}
        target="_blank"
        rel="noopener noreferrer"
        class="order-btn flex items-center justify-center gap-1.5 px-3 py-2 md:px-4 md:py-2.5 bg-accent text-white text-xs md:text-sm font-medium rounded-full hover:bg-opacity-90 transition-all"
      >
        <svg class="w-3.5 h-3.5 md:w-4 md:h-4" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/>
        </svg>
        {t.catalog.orderButton}
      </a>
      <a
        href={getLocalizedPath(`/product/${productLine.flavors[0]?.slug || ''}`, lang)}
        class="details-btn text-center px-3 py-1.5 md:px-4 md:py-2 text-xs md:text-sm font-medium text-muted hover:text-primary transition-colors"
      >
        {t.catalog.detailsButton}
      </a>
    </div>
  </div>
</article>

<style>
  .flavor-chip.selected {
    @apply border-accent bg-accent/10 text-accent font-medium;
  }
</style>

<script>
  function initProductLineCards() {
    const cards = document.querySelectorAll('.product-line-card');
    
    cards.forEach((card) => {
      const flavorChips = card.querySelectorAll('.flavor-chip');
      const detailsBtn = card.querySelector('.details-btn') as HTMLAnchorElement;
      const originalDetailsHref = detailsBtn?.getAttribute('href') || '';
      
      flavorChips.forEach((chip) => {
        chip.addEventListener('click', () => {
          const isCurrentlySelected = chip.classList.contains('selected');
          
          // Remove selection from all chips first
          flavorChips.forEach(c => c.classList.remove('selected'));
          
          if (isCurrentlySelected) {
            // Toggle off - deselect the chip
            // Reset details link to first flavor
            if (detailsBtn) {
              detailsBtn.setAttribute('href', originalDetailsHref);
            }
          } else {
            // Select this chip
            chip.classList.add('selected');
            
            // Update details link to selected flavor
            const slug = chip.getAttribute('data-slug') || '';
            if (detailsBtn && slug) {
              const basePath = originalDetailsHref.substring(0, originalDetailsHref.lastIndexOf('/product/') + 9);
              detailsBtn.setAttribute('href', basePath + slug);
            }
          }
        });
      });
    });
  }
  
  initProductLineCards();
  document.addEventListener('astro:page-load', initProductLineCards);
</script>

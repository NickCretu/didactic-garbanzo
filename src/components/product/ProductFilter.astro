---
import { useTranslations, type Language } from '@i18n/index';

interface Props {
  lang: Language;
}

const { lang } = Astro.props;
const t = useTranslations(lang);

const strengthOptions = [
  { value: 'all', label: t.catalog.filterAll },
  { value: 'low', label: t.strengths.low },
  { value: 'medium', label: t.strengths.medium },
  { value: 'strong', label: t.strengths.strong },
  { value: 'extra', label: t.strengths.extra },
];

const flavorOptions = [
  { value: 'all', label: t.catalog.filterAll },
  { value: 'mint', label: t.flavors.mint },
  { value: 'citrus', label: t.flavors.citrus },
  { value: 'berry', label: t.flavors.berry },
  { value: 'coffee', label: t.flavors.coffee },
  { value: 'tropical', label: t.flavors.tropical },
];
---

<div class="product-filter flex flex-wrap items-center justify-center gap-2 sm:gap-3 mb-6 px-4" role="group" aria-label="Product filters">
  <!-- Strength Filter Dropdown -->
  <div class="relative flex-shrink-0">
    <select 
      id="strength-filter" 
      class="filter-select appearance-none bg-surface border-0 rounded-full px-3 sm:px-4 py-2 pr-7 sm:pr-8 text-xs sm:text-sm text-muted cursor-pointer hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-accent"
      data-filter="strength"
    >
      {strengthOptions.map((option) => (
        <option value={option.value}>{t.catalog.filterStrength}: {option.label}</option>
      ))}
    </select>
    <svg class="absolute right-2 sm:right-3 top-1/2 -translate-y-1/2 w-3 sm:w-4 h-3 sm:h-4 text-muted pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </div>
  
  <!-- Flavor Filter Dropdown -->
  <div class="relative flex-shrink-0">
    <select 
      id="flavor-filter" 
      class="filter-select appearance-none bg-surface border-0 rounded-full px-3 sm:px-4 py-2 pr-7 sm:pr-8 text-xs sm:text-sm text-muted cursor-pointer hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-accent"
      data-filter="flavor"
    >
      {flavorOptions.map((option) => (
        <option value={option.value}>{t.catalog.filterFlavor}: {option.label}</option>
      ))}
    </select>
    <svg class="absolute right-2 sm:right-3 top-1/2 -translate-y-1/2 w-3 sm:w-4 h-3 sm:h-4 text-muted pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </div>
</div>

<script>
  function initFilters() {
    const filterSelects = document.querySelectorAll('.filter-select');
    const productCards = document.querySelectorAll('.product-card');
    const productSlides = document.querySelectorAll('.product-slide');
    const noProductsMsg = document.getElementById('no-products-msg');
    const productsTrack = document.getElementById('products-track');
    
    let activeFilters = {
      strength: 'all',
      flavor: 'all',
    };
    
    function updateProducts() {
      let visibleCount = 0;
      let firstVisibleSlide: Element | null = null;
      
      // Filter both desktop cards and mobile slides
      productCards.forEach((card, index) => {
        const cardStrength = card.getAttribute('data-strength');
        const cardFlavor = card.getAttribute('data-flavor');
        
        const matchesStrength = activeFilters.strength === 'all' || cardStrength === activeFilters.strength;
        const matchesFlavor = activeFilters.flavor === 'all' || cardFlavor === activeFilters.flavor;
        
        const isVisible = matchesStrength && matchesFlavor;
        
        if (isVisible) {
          (card as HTMLElement).style.display = '';
          visibleCount++;
          
          // Track first visible slide for mobile
          if (!firstVisibleSlide && productSlides[index]) {
            firstVisibleSlide = productSlides[index];
          }
        } else {
          (card as HTMLElement).style.display = 'none';
        }
        
        // Also hide/show the corresponding slide wrapper
        if (productSlides[index]) {
          (productSlides[index] as HTMLElement).style.display = isVisible ? '' : 'none';
        }
      });
      
      // Scroll carousel to first visible product
      if (firstVisibleSlide && productsTrack) {
        productsTrack.scrollTo({ left: 0, behavior: 'smooth' });
      }
      
      // Show/hide no products message
      if (noProductsMsg) {
        noProductsMsg.style.display = visibleCount === 0 ? 'block' : 'none';
      }
    }
    
    filterSelects.forEach((select) => {
      select.addEventListener('change', (e) => {
        const target = e.target as HTMLSelectElement;
        const filterType = target.getAttribute('data-filter') as 'strength' | 'flavor';
        const filterValue = target.value;
        
        // Update filter state
        activeFilters[filterType] = filterValue;
        
        // Filter products
        updateProducts();
      });
    });
  }
  
  // Initialize on page load
  initFilters();
  
  // Reinitialize on Astro page transitions
  document.addEventListener('astro:page-load', initFilters);
</script>

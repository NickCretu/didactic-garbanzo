---
import Button from '@components/ui/Button.astro';
import { useTranslations, getLocalizedPath, getTelegramOrderLink, type Language } from '@i18n/index';

interface Props {
  lang: Language;
  product: {
    slug: string;
    brand: string;
    strength: number;
    strengthCategory: string;
    flavorCategory: string;
    price: number;
    currency: string;
    image: string;
    translations: {
      [key: string]: {
        name: string;
        description: string;
      };
    };
  };
}

const { lang, product } = Astro.props;
const t = useTranslations(lang);
const translation = product.translations[lang];

const base = import.meta.env.BASE_URL || '/';
const baseClean = base.endsWith('/') ? base.slice(0, -1) : base;

// Prepend base to image path
const imageSrc = product.image.startsWith('/') 
  ? `${baseClean}${product.image}` 
  : product.image;
const placeholderSrc = `${baseClean}/images/products/placeholder.svg`;

const strengthLabels: Record<string, string> = {
  low: t.strengths.low,
  medium: t.strengths.medium,
  strong: t.strengths.strong,
  extra: t.strengths.extra,
};

const flavorLabels: Record<string, string> = {
  mint: t.flavors.mint,
  citrus: t.flavors.citrus,
  berry: t.flavors.berry,
  coffee: t.flavors.coffee,
  tropical: t.flavors.tropical,
};

const telegramLink = getTelegramOrderLink(lang, {
  name: translation.name,
  strength: product.strength,
});
---

<article
  class="product-card group flex flex-col"
  data-strength={product.strengthCategory}
  data-flavor={product.flavorCategory}
>
  <!-- Product Image -->
  <a
    href={getLocalizedPath(`/product/${product.slug}`, lang)}
    class="relative aspect-square mb-4 overflow-hidden rounded-xl bg-white"
  >
    <img
      src={imageSrc}
      alt={translation.name}
      class="w-full h-full object-contain p-4 transition-transform duration-300 group-hover:scale-105"
      loading="lazy"
      onerror={`this.src='${placeholderSrc}'`}
    />
    <!-- Strength Badge -->
    <span class="absolute top-3 right-3 px-2 py-1 bg-white/90 backdrop-blur-sm text-caption font-medium rounded-full">
      {product.strength}{t.strengths.mg}
    </span>
  </a>
  
  <!-- Product Info -->
  <div class="flex-1 flex flex-col">
    <span class="text-caption text-muted mb-1">{product.brand}</span>
    <h3 class="text-body font-medium text-primary mb-2">
      <a
        href={getLocalizedPath(`/product/${product.slug}`, lang)}
        class="hover:text-accent transition-colors"
      >
        {translation.name}
      </a>
    </h3>
    
    <!-- Tags -->
    <div class="flex flex-wrap gap-2 mb-3">
      <span class="px-2 py-0.5 bg-white text-caption text-muted rounded-full">
        {strengthLabels[product.strengthCategory]}
      </span>
      <span class="px-2 py-0.5 bg-white text-caption text-muted rounded-full">
        {flavorLabels[product.flavorCategory]}
      </span>
    </div>
    
    <!-- Price -->
    <p class="text-title font-semibold text-primary mb-4">
      {product.price} {product.currency}
    </p>
    
    <!-- Actions -->
    <div class="mt-auto flex gap-2">
      <Button href={telegramLink} variant="primary" size="sm" class="flex-1" external>
        {t.catalog.orderButton}
      </Button>
      <Button href={getLocalizedPath(`/product/${product.slug}`, lang)} variant="ghost" size="sm">
        {t.catalog.detailsButton}
      </Button>
    </div>
  </div>
</article>

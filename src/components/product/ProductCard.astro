---
import { useTranslations, getLocalizedPath, getTelegramOrderLink, type Language } from '@i18n/index';

interface Props {
  lang: Language;
  product: {
    slug: string;
    brand: string;
    strength: number;
    strengthCategory: string;
    flavorCategory: string;
    price: number;
    currency: string;
    image: string;
    translations: {
      [key: string]: {
        name: string;
        description: string;
      };
    };
  };
}

const { lang, product } = Astro.props;
const t = useTranslations(lang);
const translation = product.translations[lang];

const base = import.meta.env.BASE_URL || '/';
const baseClean = base.endsWith('/') ? base.slice(0, -1) : base;

// Prepend base to image path
const imageSrc = product.image.startsWith('/') 
  ? `${baseClean}${product.image}` 
  : product.image;
const placeholderSrc = `${baseClean}/images/products/placeholder.svg`;

const strengthLabels: Record<string, string> = {
  low: t.strengths.low,
  medium: t.strengths.medium,
  strong: t.strengths.strong,
  extra: t.strengths.extra,
};

const flavorLabels: Record<string, string> = {
  mint: t.flavors.mint,
  citrus: t.flavors.citrus,
  berry: t.flavors.berry,
  coffee: t.flavors.coffee,
  tropical: t.flavors.tropical,
};

const telegramLink = getTelegramOrderLink(lang, {
  name: translation.name,
  strength: product.strength,
});
---

<article
  class="product-card group flex flex-col overflow-hidden"
  data-strength={product.strengthCategory}
  data-flavor={product.flavorCategory}
>
  <!-- Product Image -->
  <a
    href={getLocalizedPath(`/product/${product.slug}`, lang)}
    class="relative aspect-square mb-4 overflow-hidden rounded-xl bg-white"
  >
    <img
      src={imageSrc}
      alt={translation.name}
      class="w-full h-full object-contain p-4 transition-transform duration-300 group-hover:scale-105"
      loading="lazy"
      onerror={`this.src='${placeholderSrc}'`}
    />
    <!-- Strength Badge -->
    <span class="absolute top-3 right-3 px-2.5 py-1 bg-white text-xs font-semibold text-primary rounded-full shadow-md border border-gray-100">
      {product.strength}{t.strengths.mg}
    </span>
  </a>
  
  <!-- Product Info -->
  <div class="flex-1 flex flex-col min-w-0">
    <span class="text-caption text-muted mb-1 truncate">{product.brand}</span>
    <h3 class="text-sm font-medium text-primary mb-2 line-clamp-2">
      <a
        href={getLocalizedPath(`/product/${product.slug}`, lang)}
        class="hover:text-accent transition-colors"
      >
        {translation.name}
      </a>
    </h3>
    
    <!-- Tags -->
    <div class="flex flex-wrap gap-1 mb-3">
      <span class="px-2 py-0.5 bg-white text-xs text-muted rounded-full truncate max-w-full">
        {strengthLabels[product.strengthCategory]}
      </span>
      <span class="px-2 py-0.5 bg-white text-xs text-muted rounded-full truncate max-w-full">
        {flavorLabels[product.flavorCategory]}
      </span>
    </div>
    
    <!-- Price -->
    <p class="text-base font-semibold text-primary mb-3">
      {product.price} {product.currency}
    </p>
    
    <!-- Actions -->
    <div class="mt-auto flex flex-col sm:flex-row gap-2">
      <a 
        href={telegramLink}
        target="_blank"
        rel="noopener noreferrer"
        class="order-btn flex items-center justify-center gap-2 px-4 py-2.5 bg-accent text-white text-sm font-medium rounded-full hover:bg-opacity-90 transition-all"
      >
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/>
        </svg>
        {t.catalog.orderButton}
      </a>
      <a
        href={getLocalizedPath(`/product/${product.slug}`, lang)}
        class="details-btn text-center px-4 py-2.5 text-sm font-medium text-muted hover:text-primary transition-colors"
      >
        {t.catalog.detailsButton}
      </a>
    </div>
  </div>
</article>

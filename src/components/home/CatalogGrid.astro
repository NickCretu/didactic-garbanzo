---
import { getCollection } from 'astro:content';
import ProductCard from '@components/product/ProductCard.astro';
import ProductFilter from '@components/product/ProductFilter.astro';
import { useTranslations, type Language } from '@i18n/index';

interface Props {
  lang: Language;
  showFilter?: boolean;
  limit?: number;
  featured?: boolean;
}

const { lang, showFilter = true, limit, featured = false } = Astro.props;
const t = useTranslations(lang);

// Get all products
let products = await getCollection('products');

// Filter featured if requested
if (featured) {
  products = products.filter((p) => p.data.featured);
}

// Sort by featured status and then by price
products = products.sort((a, b) => {
  if (a.data.featured && !b.data.featured) return -1;
  if (!a.data.featured && b.data.featured) return 1;
  return a.data.price - b.data.price;
});

// Apply limit if specified
if (limit) {
  products = products.slice(0, limit);
}
---

<section class="section" id="catalog">
  <div class="container">
    <h2 class="text-headline text-center mb-4">{t.catalog.title}</h2>
    <p class="text-body text-muted text-center mb-8 max-w-2xl mx-auto">
      {lang === 'en' && 'Browse our selection of premium nicotine pouches from top brands.'}
      {lang === 'ru' && 'Просмотрите нашу подборку премиальных никотиновых подушечек от ведущих брендов.'}
      {lang === 'ro' && 'Răsfoiți selecția noastră de pliculețe premium de la branduri de top.'}
    </p>
    
    {showFilter && <ProductFilter lang={lang} />}
    
    <!-- Mobile: Horizontal carousel -->
    <div class="products-carousel md:hidden">
      <div class="products-track" id="products-track">
        {products.map((product) => (
          <div class="product-slide">
            <ProductCard lang={lang} product={product.data} />
          </div>
        ))}
      </div>
      
      <!-- Carousel dots -->
      <div class="carousel-dots" id="carousel-dots"></div>
    </div>
    
    <!-- Desktop: Grid layout -->
    <div class="hidden md:grid md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
      {products.map((product) => (
        <ProductCard lang={lang} product={product.data} />
      ))}
    </div>
    
    <!-- No products message -->
    <p
      id="no-products-msg"
      class="hidden text-center text-muted py-12"
    >
      {t.catalog.noProducts}
    </p>
  </div>
</section>

<style>
  .products-carousel {
    margin: 0 -1.5rem;
    padding: 0;
    position: relative;
  }
  
  .products-track {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding: 0.5rem 1.5rem;
    gap: 1rem;
  }
  
  .products-track::-webkit-scrollbar {
    display: none;
  }
  
  .product-slide {
    flex: 0 0 75%;
    max-width: 280px;
    scroll-snap-align: center;
  }
  
  .carousel-dots {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    padding: 1rem 0;
  }
  
  .carousel-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #e5e5e5;
    transition: all 0.2s;
  }
  
  .carousel-dot.active {
    background: #0066CC;
    width: 24px;
    border-radius: 4px;
  }
</style>

<script>
  function initCarousel() {
    const track = document.getElementById('products-track');
    const dotsContainer = document.getElementById('carousel-dots');
    
    if (!track || !dotsContainer) return;
    
    const slides = track.querySelectorAll('.product-slide');
    const totalSlides = slides.length;
    
    // Create dots
    dotsContainer.innerHTML = '';
    for (let i = 0; i < Math.min(totalSlides, 10); i++) {
      const dot = document.createElement('button');
      dot.className = 'carousel-dot' + (i === 0 ? ' active' : '');
      dot.setAttribute('aria-label', `Go to slide ${i + 1}`);
      dot.addEventListener('click', () => {
        slides[i]?.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      });
      dotsContainer.appendChild(dot);
    }
    
    // Update dots on scroll
    const dots = dotsContainer.querySelectorAll('.carousel-dot');
    
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const index = Array.from(slides).indexOf(entry.target as Element);
          dots.forEach((dot, i) => {
            dot.classList.toggle('active', i === index);
          });
        }
      });
    }, {
      root: track,
      threshold: 0.5
    });
    
    slides.forEach((slide) => observer.observe(slide));
  }
  
  initCarousel();
  document.addEventListener('astro:page-load', initCarousel);
</script>

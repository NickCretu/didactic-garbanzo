---
import { getCollection } from 'astro:content';
import { useTranslations, getLocalizedPath, type Language } from '@i18n/index';

interface Props {
  lang: Language;
}

const { lang } = Astro.props;
const t = useTranslations(lang);

const base = import.meta.env.BASE_URL || '/';
const baseClean = base.endsWith('/') ? base.slice(0, -1) : base;

// Get all blog posts sorted by date
const posts = (await getCollection('blog'))
  .sort((a, b) => new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime())
  .slice(0, 3);
---

<section class="section" id="blog">
  <div class="container">
    <h2 class="text-h2 text-center mb-6 md:mb-8">{t.blog.latestPosts}</h2>
    
    <!-- Mobile: Horizontal scroll -->
    <div class="blog-carousel md:hidden">
      <div class="blog-track">
        {posts.map((post) => {
          const translation = post.data.translations[lang];
          const imageSrc = post.data.image 
            ? `${baseClean}${post.data.image}`
            : `${baseClean}/images/og-default.jpg`;
          
          return (
            <article class="blog-slide group">
              <a href={getLocalizedPath(`/blog/${translation.slug}`, lang)} class="block bg-white rounded-xl overflow-hidden shadow-sm">
                <div class="aspect-[16/10] bg-surface overflow-hidden">
                  <img
                    src={imageSrc}
                    alt={translation.title}
                    class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                    onerror={`this.style.display='none'`}
                  />
                </div>
                <div class="p-4">
                  <time class="text-caption text-muted">
                    {new Date(post.data.publishedAt).toLocaleDateString(lang, { 
                      year: 'numeric', 
                      month: 'short', 
                      day: 'numeric' 
                    })}
                  </time>
                  <h3 class="text-body font-semibold mt-1 mb-1.5 group-hover:text-accent transition-colors line-clamp-2">
                    {translation.title}
                  </h3>
                  <p class="text-small text-muted line-clamp-2">
                    {translation.excerpt}
                  </p>
                </div>
              </a>
            </article>
          );
        })}
      </div>
    </div>
    
    <!-- Desktop: Grid -->
    <div class="hidden md:grid md:grid-cols-3 gap-6">
      {posts.map((post) => {
        const translation = post.data.translations[lang];
        const imageSrc = post.data.image 
          ? `${baseClean}${post.data.image}`
          : `${baseClean}/images/og-default.jpg`;
        
        return (
          <article class="group">
            <a href={getLocalizedPath(`/blog/${translation.slug}`, lang)} class="block">
              <div class="aspect-[16/10] bg-surface rounded-xl overflow-hidden mb-3">
                <img
                  src={imageSrc}
                  alt={translation.title}
                  class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                  onerror={`this.style.display='none'`}
                />
              </div>
              <time class="text-caption text-muted">
                {new Date(post.data.publishedAt).toLocaleDateString(lang, { 
                  year: 'numeric', 
                  month: 'long', 
                  day: 'numeric' 
                })}
              </time>
              <h3 class="text-h3 mt-1.5 mb-1.5 group-hover:text-accent transition-colors">
                {translation.title}
              </h3>
              <p class="text-small text-muted line-clamp-2">
                {translation.excerpt}
              </p>
            </a>
          </article>
        );
      })}
    </div>
  </div>
</section>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .blog-carousel {
    margin: 0 -1.25rem;
  }
  
  .blog-track {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding: 0.5rem 1.25rem;
    gap: 0.75rem;
  }
  
  .blog-track::-webkit-scrollbar {
    display: none;
  }
  
  .blog-slide {
    flex: 0 0 80%;
    max-width: 280px;
    scroll-snap-align: center;
  }
</style>

---
import { getCollection } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import { useTranslations, getLocalizedPath } from '@i18n/index';

const lang = 'en';
const t = useTranslations(lang);

const base = import.meta.env.BASE_URL || '/';
const baseClean = base.endsWith('/') ? base.slice(0, -1) : base;

// Get all blog posts sorted by date
const allPosts = (await getCollection('blog'))
  .sort((a, b) => new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime());

// Get hubs
const allHubs = await getCollection('hubs');

// Group posts by hub
const postsByHub: Record<string, typeof allPosts> = {
  switching: [],
  strength: [],
  selection: [],
  safety: [],
};

allPosts.forEach(post => {
  if (postsByHub[post.data.hub]) {
    postsByHub[post.data.hub].push(post);
  }
});
---

<BaseLayout
  title="Blog - Nicotine Pouch Guides & Information"
  description="Comprehensive guides about nicotine pouches: switching from smoking, strength selection, flavor guides, safety information, and expert tips."
>
  <section class="py-12 md:py-20">
    <div class="container">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-3xl md:text-4xl font-bold mb-4">Nicotine Pouch Guides</h1>
        <p class="text-muted max-w-2xl mx-auto">
          Expert guides and information about nicotine pouches. Learn about switching from smoking, 
          choosing the right strength, flavor comparisons, and safe usage practices.
        </p>
      </div>
      
      <!-- Hub Navigation -->
      <div class="flex flex-wrap justify-center gap-3 mb-12">
        {allHubs.map(hub => {
          const hubT = hub.data.translations[lang];
          return (
            <a 
              href={`#${hub.data.hubId}`}
              class="px-4 py-2 bg-surface rounded-full text-sm font-medium hover:bg-accent hover:text-white transition-colors"
            >
              {hubT.title}
            </a>
          );
        })}
      </div>
      
      <!-- Posts by Hub -->
      {allHubs.map(hub => {
        const hubT = hub.data.translations[lang];
        const hubPosts = postsByHub[hub.data.hubId] || [];
        
        return (
          <section id={hub.data.hubId} class="mb-16">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-semibold">{hubT.title}</h2>
              <span class="text-sm text-muted">{hubPosts.length} articles</span>
            </div>
            <p class="text-muted mb-8 max-w-3xl">{hubT.intro}</p>
            
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
              {hubPosts.map(post => {
                const postT = post.data.translations[lang];
                const imageSrc = post.data.image 
                  ? `${baseClean}${post.data.image}`
                  : `${baseClean}/images/blog/placeholder.jpg`;
                
                return (
                  <article class="group">
                    <a href={getLocalizedPath(`/blog/${postT.slug}`, lang)} class="block">
                      <div class="aspect-[16/10] bg-surface rounded-xl overflow-hidden mb-3">
                        <img
                          src={imageSrc}
                          alt={postT.title}
                          class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                          loading="lazy"
                          onerror="this.style.display='none'"
                        />
                      </div>
                      <time class="text-xs text-muted">
                        {new Date(post.data.publishedAt).toLocaleDateString(lang, { 
                          year: 'numeric', 
                          month: 'long', 
                          day: 'numeric' 
                        })}
                      </time>
                      <h3 class="text-lg font-semibold mt-1 mb-2 group-hover:text-accent transition-colors line-clamp-2">
                        {postT.title}
                      </h3>
                      <p class="text-sm text-muted line-clamp-2">
                        {postT.excerpt}
                      </p>
                    </a>
                  </article>
                );
              })}
            </div>
          </section>
        );
      })}
    </div>
  </section>
</BaseLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

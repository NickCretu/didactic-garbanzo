---
import { getCollection } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import { useTranslations, getLocalizedPath, type Language } from '@i18n/index';

const lang = 'en';
const t = useTranslations(lang);

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.data.translations.en.slug },
    props: { post: post.data },
  }));
}

const { post } = Astro.props;
const translation = post.translations[lang];

const base = import.meta.env.BASE_URL || '/';
const baseClean = base.endsWith('/') ? base.slice(0, -1) : base;
const imageSrc = post.image ? `${baseClean}${post.image}` : null;

// Generate alternates with correct localized slugs for each language
const alternates: Array<{ lang: Language; url: string }> = [
  { lang: 'en', url: `/en/blog/${post.translations.en.slug}/` },
  { lang: 'ro', url: `/ro/blog/${post.translations.ro.slug}/` },
  { lang: 'ru', url: `/ru/blog/${post.translations.ru.slug}/` },
];

// Disclaimer texts
const disclaimers = {
  general: "Adult-only information. This is not medical advice. If you feel unwell or have health concerns, consult a qualified professional.",
  safety: "Adult-only information. Not medical advice. Stop use and seek professional advice if you experience concerning symptoms."
};

// Article schema for SEO
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": translation.title,
  "description": translation.metaDescription,
  "datePublished": post.publishedAt,
  "dateModified": post.updatedAt || post.publishedAt,
  "author": {
    "@type": "Organization",
    "name": "Pauch"
  }
};

// FAQ schema if FAQs exist
const faqSchema = translation.faq && translation.faq.length > 0 ? {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": translation.faq.map(item => ({
    "@type": "Question",
    "name": item.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": item.answer
    }
  }))
} : null;

// Convert markdown-like content to proper semantic HTML
function simpleMarkdown(text: string): string {
  const lines = text.split('\n');
  const output: string[] = [];
  let inList = false;
  let listType = '';
  let inParagraph = false;
  let paragraphLines: string[] = [];

  function flushParagraph() {
    if (paragraphLines.length > 0) {
      const joined = paragraphLines.join(' ').trim();
      if (joined) {
        output.push(`<p>${joined}</p>`);
      }
      paragraphLines = [];
    }
    inParagraph = false;
  }

  function closeList() {
    if (inList) {
      output.push(listType === 'ol' ? '</ol>' : '</ul>');
      inList = false;
      listType = '';
    }
  }

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    const trimmed = line.trim();

    // Skip standalone # artifacts
    if (trimmed === '#') continue;

    // Empty line: close current paragraph
    if (trimmed === '') {
      flushParagraph();
      continue;
    }

    // H2
    if (trimmed.startsWith('## ')) {
      flushParagraph();
      closeList();
      const heading = trimmed.slice(3).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      output.push(`<h2>${heading}</h2>`);
      continue;
    }

    // H3
    if (trimmed.startsWith('### ')) {
      flushParagraph();
      closeList();
      const heading = trimmed.slice(4).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      output.push(`<h3>${heading}</h3>`);
      continue;
    }

    // Unordered list item
    if (trimmed.startsWith('- ')) {
      flushParagraph();
      if (!inList || listType !== 'ul') {
        closeList();
        output.push('<ul>');
        inList = true;
        listType = 'ul';
      }
      const content = trimmed.slice(2).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      output.push(`<li>${content}</li>`);
      continue;
    }

    // Ordered list item
    const olMatch = trimmed.match(/^\d+\.\s+(.*)/);
    if (olMatch) {
      flushParagraph();
      if (!inList || listType !== 'ol') {
        closeList();
        output.push('<ol>');
        inList = true;
        listType = 'ol';
      }
      const content = olMatch[1].replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      output.push(`<li>${content}</li>`);
      continue;
    }

    // Regular text line - accumulate into paragraph
    closeList();
    const processed = trimmed.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    paragraphLines.push(processed);
    inParagraph = true;
  }

  // Flush any remaining content
  flushParagraph();
  closeList();

  return output.join('\n');
}
---

<BaseLayout
  title={translation.metaTitle}
  description={translation.metaDescription}
  image={post.image}
  alternates={alternates}
>
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} slot="head" />
  {faqSchema && <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} slot="head" />}
  
  <article class="blog-article">
    <div class="container">
      <div class="max-w-[720px] mx-auto">
        <!-- Back Link -->
        <a 
          href={getLocalizedPath('/blog/', lang)}
          class="inline-flex items-center gap-1.5 text-sm text-muted hover:text-primary transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          {t.blog.backToBlog}
        </a>
        
        <!-- Header -->
        <header class="blog-header">
          <time class="blog-meta">
            {new Date(post.publishedAt).toLocaleDateString(lang, { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            })}
          </time>
          <h1 class="blog-title">{translation.title}</h1>
          <p class="blog-excerpt">{translation.excerpt}</p>
        </header>
        
        <!-- Featured Image -->
        {imageSrc && (
          <div class="blog-featured-image">
            <img
              src={imageSrc}
              alt={translation.title}
              class="w-full h-full object-cover"
              onerror="this.parentElement.style.display='none'"
            />
          </div>
        )}
        
        <!-- Content -->
        <div class="blog-content">
          <Fragment set:html={simpleMarkdown(translation.content)} />
        </div>
        
        <!-- FAQ Section -->
        {translation.faq && translation.faq.length > 0 && (
          <div class="blog-faq">
            <h2 class="blog-faq-title">Frequently Asked Questions</h2>
            <div class="blog-faq-list">
              {translation.faq.map((item) => (
                <div class="blog-faq-item">
                  <h3 class="blog-faq-question">{item.question}</h3>
                  <p class="blog-faq-answer">{item.answer}</p>
                </div>
              ))}
            </div>
          </div>
        )}
        
        <!-- Disclaimer -->
        <div class="blog-disclaimer">
          <p>{disclaimers[post.disclaimerType]}</p>
        </div>
      </div>
    </div>
  </article>
</BaseLayout>

<style>
  /* ============================================
     Blog Article Layout
     ============================================ */
  .blog-article {
    padding-top: 2rem;
    padding-bottom: 6rem; /* Space for Telegram float */
  }

  @media (min-width: 768px) {
    .blog-article {
      padding-top: 3rem;
      padding-bottom: 4rem;
    }
  }

  /* ---- Post Header ---- */
  .blog-header {
    margin-top: 1.25rem;
    margin-bottom: 2rem;
  }

  @media (min-width: 768px) {
    .blog-header {
      margin-top: 1.5rem;
      margin-bottom: 2.5rem;
    }
  }

  .blog-meta {
    display: block;
    font-size: 0.8125rem;
    color: #86868B;
    margin-bottom: 0.75rem;
  }

  .blog-title {
    font-size: clamp(1.625rem, 5.5vw, 2.5rem);
    font-weight: 700;
    line-height: 1.2;
    letter-spacing: -0.01em;
    color: #111;
    margin: 0 0 1rem;
  }

  .blog-excerpt {
    font-size: 1.0625rem;
    line-height: 1.55;
    color: #555;
    margin: 0;
  }

  @media (min-width: 768px) {
    .blog-excerpt {
      font-size: 1.125rem;
      line-height: 1.6;
    }
  }

  /* ---- Featured Image ---- */
  .blog-featured-image {
    aspect-ratio: 16 / 9;
    background: #F5F5F7;
    border-radius: 0.75rem;
    overflow: hidden;
    margin-bottom: 2rem;
  }

  @media (min-width: 768px) {
    .blog-featured-image {
      border-radius: 1rem;
      margin-bottom: 2.5rem;
    }
  }

  /* ============================================
     Blog Content – Body Typography
     ============================================ */
  .blog-content {
    font-size: 1.0625rem;
    line-height: 1.75;
    color: #222;
    overflow-wrap: break-word;
  }

  @media (min-width: 768px) {
    .blog-content {
      font-size: 1.125rem;
      line-height: 1.8;
    }
  }

  /* ---- Paragraphs ---- */
  .blog-content p {
    margin: 0 0 1.25rem;
  }

  @media (min-width: 768px) {
    .blog-content p {
      margin-bottom: 1.5rem;
    }
  }

  /* Remove margin from empty paragraphs */
  .blog-content p:empty {
    display: none;
  }

  /* ---- H2 – Major sections ---- */
  .blog-content h2 {
    font-size: clamp(1.375rem, 4.5vw, 1.75rem);
    font-weight: 700;
    line-height: 1.25;
    letter-spacing: -0.01em;
    color: #111;
    margin: 2.5rem 0 1rem;
    padding-top: 1.5rem;
    border-top: 1px solid #eee;
  }

  /* First H2 right after the image or start doesn't need a top border */
  .blog-content > h2:first-child {
    margin-top: 0;
    padding-top: 0;
    border-top: none;
  }

  @media (min-width: 768px) {
    .blog-content h2 {
      margin: 3rem 0 1.25rem;
      padding-top: 2rem;
    }
  }

  /* ---- H3 – Subsections ---- */
  .blog-content h3 {
    font-size: clamp(1.125rem, 3.8vw, 1.375rem);
    font-weight: 600;
    line-height: 1.3;
    color: #222;
    margin: 2rem 0 0.75rem;
  }

  @media (min-width: 768px) {
    .blog-content h3 {
      margin: 2.25rem 0 0.875rem;
    }
  }

  /* ---- Lists ---- */
  .blog-content ul,
  .blog-content ol {
    margin: 0.5rem 0 1.5rem;
    padding-left: 1.5rem;
  }

  .blog-content ul {
    list-style-type: disc;
  }

  .blog-content ol {
    list-style-type: decimal;
  }

  .blog-content li {
    margin-bottom: 0.5rem;
    padding-left: 0.25rem;
    line-height: 1.65;
  }

  @media (min-width: 768px) {
    .blog-content li {
      margin-bottom: 0.625rem;
    }
  }

  /* Nested lists */
  .blog-content li > ul,
  .blog-content li > ol {
    margin-top: 0.5rem;
    margin-bottom: 0.25rem;
  }

  /* ---- Inline elements ---- */
  .blog-content strong {
    font-weight: 600;
    color: #111;
  }

  .blog-content a {
    color: #0066CC;
    text-decoration: underline;
    text-decoration-color: rgba(0, 102, 204, 0.3);
    text-underline-offset: 3px;
    transition: text-decoration-color 0.15s;
  }

  .blog-content a:hover {
    text-decoration-color: currentColor;
  }

  /* Hide heading permalink anchors */
  .blog-content a.anchor,
  .blog-content a.heading-anchor,
  .blog-content h2 a[href^="#"],
  .blog-content h3 a[href^="#"] {
    display: none !important;
  }

  /* ============================================
     FAQ Section
     ============================================ */
  .blog-faq {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid #e5e5e5;
  }

  @media (min-width: 768px) {
    .blog-faq {
      margin-top: 3.5rem;
      padding-top: 2.5rem;
    }
  }

  .blog-faq-title {
    font-size: 1.375rem;
    font-weight: 700;
    color: #111;
    margin-bottom: 1.25rem;
  }

  .blog-faq-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .blog-faq-item {
    background: #F5F5F7;
    border-radius: 0.75rem;
    padding: 1.125rem 1.25rem;
  }

  @media (min-width: 768px) {
    .blog-faq-item {
      padding: 1.25rem 1.5rem;
    }
  }

  .blog-faq-question {
    font-size: 1rem;
    font-weight: 600;
    color: #111;
    margin-bottom: 0.375rem;
  }

  .blog-faq-answer {
    font-size: 0.9375rem;
    color: #555;
    line-height: 1.6;
  }

  /* ============================================
     Disclaimer
     ============================================ */
  .blog-disclaimer {
    margin-top: 2.5rem;
    padding: 1rem 1.25rem;
    background: #fafafa;
    border: 1px solid #e5e5e5;
    border-radius: 0.75rem;
  }

  .blog-disclaimer p {
    font-size: 0.8125rem;
    color: #86868B;
    margin: 0;
    line-height: 1.55;
  }
</style>

---
import { getCollection } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import { useTranslations, getLocalizedPath, type Language } from '@i18n/index';

const lang = 'en';
const t = useTranslations(lang);

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.data.translations.en.slug },
    props: { post: post.data },
  }));
}

const { post } = Astro.props;
const translation = post.translations[lang];

const base = import.meta.env.BASE_URL || '/';
const baseClean = base.endsWith('/') ? base.slice(0, -1) : base;
const imageSrc = post.image ? `${baseClean}${post.image}` : null;

// Generate alternates with correct localized slugs for each language
const alternates: Array<{ lang: Language; url: string }> = [
  { lang: 'en', url: `/en/blog/${post.translations.en.slug}/` },
  { lang: 'ro', url: `/ro/blog/${post.translations.ro.slug}/` },
  { lang: 'ru', url: `/ru/blog/${post.translations.ru.slug}/` },
];

// Disclaimer texts
const disclaimers = {
  general: "Adult-only information. This is not medical advice. If you feel unwell or have health concerns, consult a qualified professional.",
  safety: "Adult-only information. Not medical advice. Stop use and seek professional advice if you experience concerning symptoms."
};

// Article schema for SEO
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": translation.title,
  "description": translation.metaDescription,
  "datePublished": post.publishedAt,
  "dateModified": post.updatedAt || post.publishedAt,
  "author": {
    "@type": "Organization",
    "name": "Pauch"
  }
};

// FAQ schema if FAQs exist
const faqSchema = translation.faq && translation.faq.length > 0 ? {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": translation.faq.map(item => ({
    "@type": "Question",
    "name": item.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": item.answer
    }
  }))
} : null;

// Convert markdown-like content to HTML (simple conversion)
function simpleMarkdown(text: string): string {
  return text
    .replace(/## (.*?)$/gm, '<h2 class="text-xl font-semibold mt-8 mb-4 text-primary">$1</h2>')
    .replace(/### (.*?)$/gm, '<h3 class="text-lg font-semibold mt-6 mb-3 text-primary">$1</h3>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n\n/g, '</p><p class="text-body text-muted mb-4">')
    .replace(/^\d\. (.*?)$/gm, '<li class="mb-2">$1</li>')
    .replace(/^- (.*?)$/gm, '<li class="mb-2">$1</li>')
    .replace(/\n/g, '<br/>');
}
---

<BaseLayout
  title={translation.metaTitle}
  description={translation.metaDescription}
  image={post.image}
  alternates={alternates}
>
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} slot="head" />
  {faqSchema && <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} slot="head" />}
  
  <article class="py-12 md:py-20">
    <div class="container">
      <div class="max-w-3xl mx-auto">
        <!-- Back Link -->
        <a 
          href={getLocalizedPath('/', lang) + '#blog'}
          class="inline-flex items-center gap-2 text-muted hover:text-primary mb-8 transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          {t.blog.backToBlog}
        </a>
        
        <!-- Header -->
        <header class="mb-8">
          <time class="text-caption text-muted">
            {new Date(post.publishedAt).toLocaleDateString(lang, { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            })}
          </time>
          <h1 class="text-2xl md:text-4xl font-semibold mt-2 mb-4">{translation.title}</h1>
          <p class="text-sm md:text-base text-muted">{translation.excerpt}</p>
        </header>
        
        <!-- Featured Image -->
        {imageSrc && (
          <div class="aspect-[16/9] bg-surface rounded-2xl overflow-hidden mb-12">
            <img
              src={imageSrc}
              alt={translation.title}
              class="w-full h-full object-cover"
              onerror="this.parentElement.style.display='none'"
            />
          </div>
        )}
        
        <!-- Content -->
        <div class="prose prose-lg max-w-none">
          <p class="text-body text-muted mb-4">
            <Fragment set:html={simpleMarkdown(translation.content)} />
          </p>
        </div>
        
        <!-- FAQ Section -->
        {translation.faq && translation.faq.length > 0 && (
          <div class="mt-12 pt-8 border-t border-gray-200">
            <h2 class="text-xl font-semibold mb-6">Frequently Asked Questions</h2>
            <div class="space-y-4">
              {translation.faq.map((item) => (
                <div class="bg-surface rounded-xl p-5">
                  <h3 class="font-medium text-primary mb-2">{item.question}</h3>
                  <p class="text-muted text-sm">{item.answer}</p>
                </div>
              ))}
            </div>
          </div>
        )}
        
        <!-- Disclaimer -->
        <div class="mt-12 p-4 bg-gray-50 rounded-xl border border-gray-200">
          <p class="text-xs text-muted">
            {disclaimers[post.disclaimerType]}
          </p>
        </div>
      </div>
    </div>
  </article>
</BaseLayout>

<style>
  .prose h2 {
    @apply text-title font-semibold mt-8 mb-4;
  }
  .prose h3 {
    @apply text-body font-semibold mt-6 mb-3;
  }
  .prose p {
    @apply text-body text-muted mb-4;
  }
  .prose ul, .prose ol {
    @apply list-disc pl-6 mb-4 text-body text-muted;
  }
  .prose li {
    @apply mb-2;
  }
  .prose strong {
    @apply font-semibold text-primary;
  }
</style>

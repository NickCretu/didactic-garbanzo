---
import { getCollection } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import { useTranslations, getLocalizedPath, type Language } from '@i18n/index';

const lang = 'en';
const t = useTranslations(lang);

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.data.translations.en.slug },
    props: { post: post.data },
  }));
}

const { post } = Astro.props;
const translation = post.translations[lang];

const base = import.meta.env.BASE_URL || '/';
const baseClean = base.endsWith('/') ? base.slice(0, -1) : base;
const imageSrc = post.image ? `${baseClean}${post.image}` : null;

// Generate alternates with correct localized slugs for each language
const alternates: Array<{ lang: Language; url: string }> = [
  { lang: 'en', url: `/en/blog/${post.translations.en.slug}/` },
  { lang: 'ro', url: `/ro/blog/${post.translations.ro.slug}/` },
  { lang: 'ru', url: `/ru/blog/${post.translations.ru.slug}/` },
];

// Disclaimer texts
const disclaimers = {
  general: "Adult-only information. This is not medical advice. If you feel unwell or have health concerns, consult a qualified professional.",
  safety: "Adult-only information. Not medical advice. Stop use and seek professional advice if you experience concerning symptoms."
};

// Article schema for SEO
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": translation.title,
  "description": translation.metaDescription,
  "datePublished": post.publishedAt,
  "dateModified": post.updatedAt || post.publishedAt,
  "author": {
    "@type": "Organization",
    "name": "Pauch"
  }
};

// FAQ schema if FAQs exist
const faqSchema = translation.faq && translation.faq.length > 0 ? {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": translation.faq.map(item => ({
    "@type": "Question",
    "name": item.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": item.answer
    }
  }))
} : null;

// Convert markdown-like content to HTML (simple conversion)
function simpleMarkdown(text: string): string {
  return text
    // Remove any standalone # that might be anchors or artifacts
    .replace(/^#\s*$/gm, '')
    .replace(/## (.*?)$/gm, '<h2>$1</h2>')
    .replace(/### (.*?)$/gm, '<h3>$1</h3>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n\n/g, '</p><p>')
    .replace(/^\d+\. (.*?)$/gm, '<li>$1</li>')
    .replace(/^- (.*?)$/gm, '<li>$1</li>')
    .replace(/\n/g, '<br/>');
}
---

<BaseLayout
  title={translation.metaTitle}
  description={translation.metaDescription}
  image={post.image}
  alternates={alternates}
>
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} slot="head" />
  {faqSchema && <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} slot="head" />}
  
  <article class="blog-article">
    <div class="container">
      <div class="max-w-[720px] mx-auto">
        <!-- Back Link -->
        <a 
          href={getLocalizedPath('/blog/', lang)}
          class="inline-flex items-center gap-1.5 text-sm text-muted hover:text-primary transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          {t.blog.backToBlog}
        </a>
        
        <!-- Header -->
        <header class="blog-header">
          <time class="blog-meta">
            {new Date(post.publishedAt).toLocaleDateString(lang, { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            })}
          </time>
          <h1 class="blog-title">{translation.title}</h1>
          <p class="blog-excerpt">{translation.excerpt}</p>
        </header>
        
        <!-- Featured Image -->
        {imageSrc && (
          <div class="blog-featured-image">
            <img
              src={imageSrc}
              alt={translation.title}
              class="w-full h-full object-cover"
              onerror="this.parentElement.style.display='none'"
            />
          </div>
        )}
        
        <!-- Content -->
        <div class="blog-content">
          <Fragment set:html={simpleMarkdown(translation.content)} />
        </div>
        
        <!-- FAQ Section -->
        {translation.faq && translation.faq.length > 0 && (
          <div class="blog-faq">
            <h2 class="blog-faq-title">Frequently Asked Questions</h2>
            <div class="blog-faq-list">
              {translation.faq.map((item) => (
                <div class="blog-faq-item">
                  <h3 class="blog-faq-question">{item.question}</h3>
                  <p class="blog-faq-answer">{item.answer}</p>
                </div>
              ))}
            </div>
          </div>
        )}
        
        <!-- Disclaimer -->
        <div class="blog-disclaimer">
          <p>{disclaimers[post.disclaimerType]}</p>
        </div>
      </div>
    </div>
  </article>
</BaseLayout>

<style>
  /* Blog Article Layout - Mobile-first */
  .blog-article {
    padding: 1.5rem 0 5rem; /* Extra bottom padding for Telegram button */
  }
  
  @media (min-width: 768px) {
    .blog-article {
      padding: 2.5rem 0 3rem;
    }
  }
  
  /* Blog Header - Compact spacing */
  .blog-header {
    margin-top: 0.75rem;
    margin-bottom: 1.25rem;
  }
  
  @media (min-width: 768px) {
    .blog-header {
      margin-top: 1rem;
      margin-bottom: 1.5rem;
    }
  }
  
  .blog-meta {
    font-size: 0.8125rem;
    color: #86868B;
    display: block;
  }
  
  .blog-title {
    font-size: clamp(1.5rem, 5.5vw, 2.25rem);
    font-weight: 600;
    line-height: 1.15;
    color: #000;
    margin: 0.5rem 0 0.625rem;
  }
  
  @media (min-width: 768px) {
    .blog-title {
      margin: 0.625rem 0 0.75rem;
    }
  }
  
  .blog-excerpt {
    font-size: 0.9375rem;
    line-height: 1.5;
    color: #86868B;
    margin: 0;
  }
  
  @media (min-width: 768px) {
    .blog-excerpt {
      font-size: 1rem;
    }
  }
  
  /* Featured Image */
  .blog-featured-image {
    aspect-ratio: 16 / 9;
    background: #F5F5F7;
    border-radius: 0.75rem;
    overflow: hidden;
    margin-bottom: 1.5rem;
  }
  
  @media (min-width: 768px) {
    .blog-featured-image {
      border-radius: 1rem;
      margin-bottom: 2rem;
    }
  }
  
  /* Blog Content - Typography */
  .blog-content {
    font-size: 1rem;
    line-height: 1.65;
    color: #1a1a1a; /* Dark text for readability */
    hyphens: auto;
    overflow-wrap: break-word;
  }
  
  @media (min-width: 768px) {
    .blog-content {
      font-size: 1.0625rem;
      line-height: 1.7;
    }
  }
  
  /* Paragraphs */
  .blog-content p {
    margin-bottom: 0.875rem;
  }
  
  @media (min-width: 768px) {
    .blog-content p {
      margin-bottom: 1rem;
    }
  }
  
  /* Headings - Tighter spacing */
  .blog-content h2 {
    font-size: clamp(1.25rem, 4.5vw, 1.5rem);
    font-weight: 600;
    line-height: 1.2;
    color: #000;
    margin-top: 1.75rem;
    margin-bottom: 0.625rem;
  }
  
  @media (min-width: 768px) {
    .blog-content h2 {
      margin-top: 2rem;
      margin-bottom: 0.75rem;
    }
  }
  
  .blog-content h3 {
    font-size: clamp(1.0625rem, 3.8vw, 1.25rem);
    font-weight: 600;
    line-height: 1.25;
    color: #000;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
  }
  
  @media (min-width: 768px) {
    .blog-content h3 {
      margin-top: 1.75rem;
      margin-bottom: 0.5rem;
    }
  }
  
  /* Lists - Tighter spacing */
  .blog-content ul,
  .blog-content ol {
    margin: 0.75rem 0 1rem;
    padding-left: 1.25rem;
  }
  
  .blog-content ul {
    list-style-type: disc;
  }
  
  .blog-content ol {
    list-style-type: decimal;
  }
  
  .blog-content li {
    margin-bottom: 0.375rem;
    padding-left: 0.25rem;
  }
  
  @media (min-width: 768px) {
    .blog-content li {
      margin-bottom: 0.5rem;
    }
  }
  
  /* Strong text */
  .blog-content strong {
    font-weight: 600;
    color: #000;
  }
  
  /* Links in content */
  .blog-content a {
    color: #0066CC;
    text-decoration: underline;
    text-decoration-color: rgba(0, 102, 204, 0.3);
    text-underline-offset: 2px;
  }
  
  .blog-content a:hover {
    text-decoration-color: currentColor;
  }
  
  /* Hide any anchor/permalink symbols */
  .blog-content a.anchor,
  .blog-content a.heading-anchor,
  .blog-content h2 a[href^="#"],
  .blog-content h3 a[href^="#"] {
    display: none !important;
  }
  
  /* FAQ Section */
  .blog-faq {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e5e5;
  }
  
  @media (min-width: 768px) {
    .blog-faq {
      margin-top: 2.5rem;
      padding-top: 2rem;
    }
  }
  
  .blog-faq-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #000;
    margin-bottom: 1rem;
  }
  
  .blog-faq-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .blog-faq-item {
    background: #F5F5F7;
    border-radius: 0.75rem;
    padding: 1rem;
  }
  
  @media (min-width: 768px) {
    .blog-faq-item {
      padding: 1.25rem;
    }
  }
  
  .blog-faq-question {
    font-size: 0.9375rem;
    font-weight: 500;
    color: #000;
    margin-bottom: 0.375rem;
  }
  
  .blog-faq-answer {
    font-size: 0.875rem;
    color: #86868B;
    line-height: 1.5;
  }
  
  /* Disclaimer */
  .blog-disclaimer {
    margin-top: 2rem;
    padding: 0.875rem 1rem;
    background: #fafafa;
    border: 1px solid #e5e5e5;
    border-radius: 0.75rem;
  }
  
  .blog-disclaimer p {
    font-size: 0.75rem;
    color: #86868B;
    margin: 0;
    line-height: 1.5;
  }
</style>

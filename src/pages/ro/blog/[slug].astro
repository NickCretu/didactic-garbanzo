---
import { getCollection } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import { useTranslations, getLocalizedPath } from '@i18n/index';

const lang = 'ro';
const t = useTranslations(lang);

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.data.slug },
    props: { post: post.data },
  }));
}

const { post } = Astro.props;
const translation = post.translations[lang];

const base = import.meta.env.BASE_URL || '/';
const baseClean = base.endsWith('/') ? base.slice(0, -1) : base;
const imageSrc = post.image ? `${baseClean}${post.image}` : null;

function simpleMarkdown(text: string): string {
  return text
    .replace(/## (.*?)$/gm, '<h2 class="text-title font-semibold mt-8 mb-4">$1</h2>')
    .replace(/### (.*?)$/gm, '<h3 class="text-body font-semibold mt-6 mb-3">$1</h3>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n\n/g, '</p><p class="text-body text-muted mb-4">')
    .replace(/^\d\. (.*?)$/gm, '<li class="mb-2">$1</li>')
    .replace(/^- (.*?)$/gm, '<li class="mb-2">$1</li>')
    .replace(/\n/g, '<br/>');
}
---

<BaseLayout
  title={`${translation.title} - ${t.site.title}`}
  description={translation.excerpt}
  image={post.image}
>
  <article class="py-12 md:py-20">
    <div class="container">
      <div class="max-w-3xl mx-auto">
        <a 
          href={getLocalizedPath('/', lang) + '#blog'}
          class="inline-flex items-center gap-2 text-muted hover:text-primary mb-8 transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          {t.blog.backToBlog}
        </a>
        
        <header class="mb-8">
          <time class="text-caption text-muted">
            {new Date(post.date).toLocaleDateString(lang, { year: 'numeric', month: 'long', day: 'numeric' })}
          </time>
          <h1 class="text-display mt-2 mb-4">{translation.title}</h1>
          <p class="text-body text-muted text-lg">{translation.excerpt}</p>
        </header>
        
        {imageSrc && (
          <div class="aspect-[16/9] bg-surface rounded-2xl overflow-hidden mb-12">
            <img src={imageSrc} alt={translation.title} class="w-full h-full object-cover" onerror="this.parentElement.style.display='none'" />
          </div>
        )}
        
        <div class="prose prose-lg max-w-none">
          <p class="text-body text-muted mb-4"><Fragment set:html={simpleMarkdown(translation.content)} /></p>
        </div>
      </div>
    </div>
  </article>
</BaseLayout>

<style>
  .prose h2 { @apply text-title font-semibold mt-8 mb-4; }
  .prose h3 { @apply text-body font-semibold mt-6 mb-3; }
  .prose p { @apply text-body text-muted mb-4; }
  .prose ul, .prose ol { @apply list-disc pl-6 mb-4 text-body text-muted; }
  .prose li { @apply mb-2; }
  .prose strong { @apply font-semibold text-primary; }
</style>
